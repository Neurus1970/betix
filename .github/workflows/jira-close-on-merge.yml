name: Jira - Sincronizar estado al cerrar PR

on:
  pull_request:
    types: [closed]
    branches: [main]

jobs:
  sync-jira-ticket:
    name: Transicionar ticket Jira según resultado de PR
    runs-on: ubuntu-latest

    steps:
      - name: Extraer ticket ID del nombre de la branch
        id: extract
        run: |
          BRANCH="${{ github.event.pull_request.head.ref }}"
          TICKET=$(echo "$BRANCH" | grep -oE '[A-Z]+-[0-9]+' | head -1)
          echo "ticket=$TICKET" >> $GITHUB_OUTPUT
          if [ -z "$TICKET" ]; then
            echo "No se encontró ticket Jira en la branch: $BRANCH"
          else
            echo "Ticket encontrado: $TICKET"
          fi

      - name: Determinar transición
        id: transition
        if: steps.extract.outputs.ticket != ''
        run: |
          if [ "${{ github.event.pull_request.merged }}" == "true" ]; then
            echo "id=31" >> $GITHUB_OUTPUT
            echo "label=Done" >> $GITHUB_OUTPUT
          else
            echo "id=11" >> $GITHUB_OUTPUT
            echo "label=To Do" >> $GITHUB_OUTPUT
          fi

      - name: Transicionar ticket en Jira
        if: steps.extract.outputs.ticket != ''
        run: |
          TICKET="${{ steps.extract.outputs.ticket }}"
          TRANSITION_ID="${{ steps.transition.outputs.id }}"
          LABEL="${{ steps.transition.outputs.label }}"
          echo "Moviendo $TICKET a $LABEL..."

          HTTP_STATUS=$(curl --silent \
            --output /tmp/jira-response.json \
            --write-out "%{http_code}" \
            --request POST \
            --url "${{ secrets.JIRA_BASE_URL }}/rest/api/3/issue/$TICKET/transitions" \
            --user "${{ secrets.JIRA_USER_EMAIL }}:${{ secrets.JIRA_API_TOKEN }}" \
            --header "Content-Type: application/json" \
            --data "{\"transition\":{\"id\":\"$TRANSITION_ID\"}}")

          echo "HTTP Status: $HTTP_STATUS"
          cat /tmp/jira-response.json

          if [ "$HTTP_STATUS" -eq 204 ]; then
            echo "✅ $TICKET → $LABEL"
          else
            echo "❌ No se pudo transicionar $TICKET (HTTP $HTTP_STATUS)"
            exit 1
          fi
